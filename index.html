<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="what&apos;s past is prologue">
<meta name="keywords" content="keywords_eg">
<meta property="og:type" content="website">
<meta property="og:title" content="renz">
<meta property="og:url" content="https://renzheng0403.github.io/index.html">
<meta property="og:site_name" content="renz">
<meta property="og:description" content="what&apos;s past is prologue">
<meta property="og:locale" content="zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="renz">
<meta name="twitter:description" content="what&apos;s past is prologue">






  <link rel="canonical" href="https://renzheng0403.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>renz</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">renz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">what's past is prologue</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/11/25/被嫌弃的松子的一生/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/25/被嫌弃的松子的一生/" itemprop="url">
                  被嫌弃的松子的一生
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-25 23:27:00" itemprop="dateCreated datePublished" datetime="2017-11-25T23:27:00+08:00">2017-11-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 09:46:25" itemprop="dateModified" datetime="2018-05-19T09:46:25+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后感/" itemprop="url" rel="index"><span itemprop="name">后感</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从松子的角度来看，被嫌弃的一生其实是追寻的一生。<br>看这个电影，我们可能会像一个看客一样思考，假如松子怎么怎么样。要知道，任何时候我们谈论，假如松子在某个人生的节点如果做出某个在你看来可能更合理的选择都是不客观的。她的一生每一个选择，背后都透露出她的人生态度，这份态度坚决，清晰。<br>这个剧的编剧大概是个太宰治的铁粉，不仅剧中多次出现了相关因素，例如松子被开除后跟随的那个专职作家，自命太宰治的转身;例如杀了合伙人之后选择了结生命的地点。最重要的大概就是该剧与《人间失格》的对比。<br>两部作品构建的根基都是相同的，甚至可能都不是构建，就是赤裸裸的现实。主人公的一生都活在渴望爱却又缺失爱的境地，用刻意扭曲搞怪的面容企图逗乐他人，见证了人性的丑恶，经历的孤独的痛苦，最后在凄惨的年月中年迈死去。不知是否是刻意为之，松子却选择了与叶藏看似不同的选择。</p>
<blockquote>
<p>胆小鬼连幸福都会害怕，碰到棉花都会受伤，有时还会被幸福所伤</p>
</blockquote>
<p>这就是叶藏表现出来的外在性质，但是松子却是一个爱的热烈而坚定的女人。对于太宰治转身的作家男友的爱，对于自杀未遂遇到的理发师的坚守，对于阿龙的生死与共。可是这些在有些人谈论爱情时刻意强调的必备品质并没有为松子带来多少命运的青睐。你会发现撇开人生的意义来单独谈论爱情是没有意义的。纯粹的爱情活在春秋时期，活在希腊史诗中，活在人类文明早期的探索，稍有认知却又认知不全。<br>老实说我对于文学和哲学并没有什么像样的系统学习，只是在某个时期出于本能为了解决自己的性格问题而阅读了一些书，这也是以荒废了理科课程的学习为代价。所以你可以看到，我写的文章都是难登大雅之堂的唠磕。<br>我们在一生之中也会遇到松子的难题，我们都采取了聪明的做法，所以我们看似过得幸福，但是人生也变得没有意义。举身边安稳度日的长辈的例子，相比于那些晚年过得没有他们幸福的长辈来说，他们总是<strong>仿佛</strong>脸上有光。可是他们依然没有得到成长，这就好像做课题研究一样，研究是一件逆熵的过程，总要付出一些代价例如思考、汗水、时间等等，他们避开了这些麻烦，没有接下课题研究的任务，自然也就不会有一个认知的经历过程。可是松子啊，从头到尾都在接受这类课题研究，而且从小到老，随着研究的深入，认知程度也越来越高。如果说人生真的只是一个试炼的话，那么无论是松子还是叶藏，她们都是我们中的佼佼者。<br>写到这里，我也总算对于如何讲述这个感想有了思路，以人生的课题来讲述或许是最符合我的思路，也是我最能把事情将清楚的方式了。</p>
<p>我们先看松子小时候接受的课题吧。要解释这个问题其实也不难，专业术语还真忘了，貌似叫什么情感反馈缺失。也就是说小松子的父母因为太过关心患病的妹妹，忽略了松子的情感需求，就像嗷嗷待哺的雏鸟，长大了嘴却没有被喂食。小松子对于爱的需求，对于焦点的获得，体现在做鬼脸上，这点如出一辙的出现在《人间失格》里。在这个课题上，小松子的处理已经超过很多人了。我妈妈可以举出处理不当的两种反例，这要算我妈最早提出的一个假设。我妈发现一个奇怪的现象，就是有三到四个孩子的家庭里，假如前两个是女孩，那么二女儿的性格通常都会有些怪异。这个例子在我小时候经常生病去的那家医疗室的医生家里很好的体现出来。医疗室是医生夫妇打理，家就在二楼。大女儿又漂亮学习又好，二女儿在学校里打架惹事，穿的也没有医生家里的大小姐，小儿子貌似也挺憨，我那个时候可能只注意大女儿了，年龄比我大不了多少，又很漂亮。我妈的解释是这样的家庭结构，大女儿肯定不会受到忽视，小儿子就更不会了，二女儿可能管教就少了。她还举了我姑家的例子，不过好在我姑对孩子真的是一视同仁，尽管如此二女儿还是有点点怪异。最后我妈又举了自己的例子，我才意识到原来是深有体会。我妈在怀我的时候的那个爆炸头照片现在还很前卫。松子呢，同样的受到忽视，但是没有打架斗殴自暴自弃，也没有沉默寡言自卑自弱，而是学会了鬼脸斗父亲笑，可以说很积极了，又有多少家小孩可以做到这点呢。而且松子通过这招，稍微的达成了焦点的吸引。</p>
<p>第二个课题出现在松子做中学教师的时候。这个课题是没有成功处理的吧，应该是受小时候的影响太深了。这个课题归结为<strong>对他人的需求</strong>。松子在与人面对面交流的时候很难对人说NO，当阿龙在她面前的时候，当阿龙拿出信任这把武器的时候，松子宁愿推翻”是阿龙偷的“这个结论也要提供给阿龙信任，只有当阿龙走的时候才又从新建立结论。当面对店铺老板坚决要求小偷必须当场道歉的时候，情急之前使用本能——做鬼脸，也没有拒绝见小偷这个要求。不敢拒绝，最终生出妥协，成了牺牲品。这个课题是有些难度的，老实说换作是你也不能在段时间内很好的解决。<br>由于这个课题的因是第一个课题的果，导致松子崩溃，进而也将第一个课题的隐患引爆——嫉妒受到关注与呵护的妹妹。</p>
<p>第三个课题算是<strong>爱情与归宿</strong>，但是爱情占据大半，归宿的意味没有后面有个课题强。这个时期的松子与家人断绝了关系，有了一个自比于太宰治转世的男友，可是啊，我相信无论是太宰治还是他小说的主人公，都不会对女性施暴，他们对于女性的态度应该是谄媚和逗乐居多，要么逃避，绝不会出现施暴这一回，这点编剧是不是真心理解偏了，我觉得如果把施暴换成对女性的隐形勾引会更符合太宰治化身这一形象。而且这里的施暴和后面阿龙的施暴明显重合。如果参考《维庸之妻》设计这段情节会更符合。但是无论怎样，这个专职作家都不是一个好的归宿，至于为什么会对这样的人产生爱情，还有爱情究竟是真的还是只是一种表象，对不起，不知道。事实就是松子爱的坚定，爱的不可理喻，爱的遍体鳞伤。<br>在这个课题上，每个人都有每个人的见解，我也和你们一样认为如果施暴，为什么还要在一起，是受虐习惯了吗？会选择离开，但是松子在这个课题上可能还真的做的更好一点。她认定了那就是爱情，事实证明这点她没有错，不会象我们一样因为某些客观因素选择放弃，其实就是放弃爱情。作家自杀后，她也就失去了爱情。爱情的恨与别，折磨与不舍，松子在这个课题里都提会了。</p>
<p>第四个课题延续了第二个课题，即<strong>对他人说NO</strong>的能力。在这个课题里面，松子绝对是选择了一个任性而三观级正的做法，让我们得以看见一个人生逐渐成熟的松子。<br>松子与人合伙做生意，但是合伙人毁约并私吞了松子的心血，在合伙人的欺凌下，松子内心毫无波澜（可能说错了，是很气愤），我们可以看到松子与合伙人直接的心理对峙外加身体反抗。我记得电影里在之前好像铺垫说是作家死了万念俱灰，做这样一个铺垫我不能认同，这是不切和生活的小说的写法，但既然是太宰治流，那么绝对离不开心理的变革。<br>松子在整体上是一个面对困难积极寻找解决办法的人，第一个课题里就讲到她在面对情感反馈缺失就解决的很好，那么在后来她应该会从第二个课题的处理失败中找到正确的处理办法——说NO。而且她说的很彻底，将合伙人杀了。<br>这个课题我不知道你们怎么看，但是我觉得很爽，这是一个已经成熟的人了，如果是这时候的松子来处理第二个课题，那么就不会出现这么多的事情了。人无论怎么犯错，都不过是一个经历与否的问题，所以不要说松子应该怎样做，她做不到的你绝对做不到，因为她代表的是小说家抽象出来的假设，是一种贴近真实的理想状态。</p>
<p>第五个课题就是彻底的<strong>归宿感</strong>了，也是让人忍不住泪目的地方。自杀未遂的松子遇见的理发师就代表了这样一种状态，他其貌不扬，有着中年普通人发福的面孔，做着安稳的职业过着安稳的一生，脾气温柔对人友善，对于经历过这么多的松子来说极具诱惑力。也就是在这个港湾里松子体会到了生活得快乐，我记得这一段镜头特别的祥和，松子也浑身散发圣母的光辉。<br>这是我们普通人认为最明智的选择吧，走到如今这一步的松子也很想就这样生活，所以被警方抓到坐牢，才会眼睛里充满积极的光，对未来的生活充满渴望。在她的想象里，出狱后他就可以与理发师过上这种生活了。可是这种生活得事实是怎样的呢？如果这种生活真的如此理想，为什么文学作品里总是描写不同于此的情况。一种猜想是，这种现实里的生活只是一种妥协。我们对命运低头迷失在了生活得柴米油盐之中，迷失了经由课题感悟人生的可能。这种妥协事实上也是脆弱的，它没有爱情那种强有力的看不见的联系，顶多有某种声称具有法律效率的文件来作为保证。不知道是人类社会的进化还是仅仅作为社会的一种临时状态，说不定我们最终还会重回古时候那种纯粹爱情的时代。<br>挽回正题，出狱的松子怀着怎样的期待不知你能否体会一下，理发店越来越近，走到门口却发现了新的女主人和孩子，松子就这么在门口说了一句早已准备好的台词“我回来了”，离开了，屋内的人谁也没有注意到外面曾有过一个自由的灵魂。<br>你看，即使是松子也和你我一样，败给了归宿感，我们都不愿意再漂泊了。然而这种虚假的归宿感由于其本身的脆弱属性，将松子最后一点希望破灭。</p>
<p>第六个是真正的关于<strong>爱情</strong>的课题了，在这个课题里，你可以也印证了前一个课题 归属感的破灭。我记得在第三个课题里，我没有很好将其归属与<strong>爱情</strong>还是<strong>归宿</strong>，写道这里我自己忽然明白了，因为没有放弃归宿，所以二者兼而有之。但是这里就分得很明确了，最终选择抛弃归宿的松子对于爱情变得更加彻底而疯狂，好像这已经是她最后的精神稻草了。<br>阿龙，这个在第一个课题里将她陷入困境的人，向她坦白了爱意，松子悲愤，只说了句讨厌雨天。只怕是阿龙将从前的事如过山车勾起。<br>回味一下对话：<br><code>你有那么恨我吗？</code><br><code>正相反。</code><br>这样课题涉及的往事不知道该怎么说，如果你想了解什么叫“我只会给松子带来伤害”这段阿龙的内心独白，就一定要看一遍《人间失格》才会懂，大概就是爱到深处才会远离，但是日本人会将这一感情的绝望升华至人生的绝望，才会知道阿龙，这个两度带给松子灾祸的根源，却也因对松子的爱生活在痛苦之中，也算是阿龙的课题吧。阿龙的课题——爱、自我否定。而阿龙在自己的课题——自我否定的错误处理，将松子彻底的推向深渊。<br>到了这一步，阿龙错误的认为自己带给松子的只有痛苦，离开了松子。而松子在对阿龙的期盼落空后，也封闭了自己。<br>另外两个课题分别是友情和偶像，也都以处理失败告终，暂时不想写了，有空再说吧。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/11/17/关乎信仰，关乎经历/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/17/关乎信仰，关乎经历/" itemprop="url">
                  可怕的信仰
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-17 23:57:00" itemprop="dateCreated datePublished" datetime="2017-11-17T23:57:00+08:00">2017-11-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 10:03:15" itemprop="dateModified" datetime="2018-05-19T10:03:15+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后感/" itemprop="url" rel="index"><span itemprop="name">后感</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>看完《血战钢锯岭》，不得不说还真被Doss的天真无邪给洗了一下我略肮脏的大脑，再加上改编自真人真事，更加让人佩服了。<br>我是相信真有如此信仰坚定之人，虽然不是刻意为之，但是表现确实异于常人。他们好像不懂人情事故，不肯变通，于是我心里不免暗叹一声，涉世未深，涉世未深啊。其实啊，他们究竟经历了哪些生命中不能承受的痛苦，谁也不知道。每次遇到这类人，他们的天真都像一盏发亮的光环，吸引我去观察。<br>我首先揣测，唔，这个家伙，性情乖张，不食人间烟火，肯定是从小生活在安乐乡，偶然性的生活在阳关下，无死角。不对，也许是从小就经历太多已经看淡人生了，你的这点小99在他眼里不算什么。你可以妄加评判一个人的性格，却不能说出这个性格背后代表的真正人格，那么评论一个人的性格又有什么意义呢？<br>如果我没有记错的话，《三体》里记录了一个关于乐观人格和悲观人格的对比。我们先从表象来评判性格。a积极进取，坚信人类科技在有限时间内一定能够取得重大进展，从而能够进行宇宙航行，脱离灭绝的危险，那么我们称a为乐观主义者。b呢，他根据现有的事实推断人类的时间已经不够等到科技成熟的那一天，人类摆脱不了灭绝的结局，我们称b为悲观主义者。<br>事实情况相反，a是一个彻底的悲观主义者，他也一样深知人类的弱小，即使科技取得进步，也有可能被更加强大的外力摧毁，他所做的一切，都是想尽最大的努力逃离地球。正是因为对人类的绝对悲观，才最终促使他即使在人类科技真的取得巨大进展的情况下，仍然义无反顾的选择逃离。这是何等的悲观啊！简直可以媲美那些即使我们国家富强了，也一心想要抓紧移民的人，一模一样啊亲。<br>好了，为什么要说这个呢？只是想说，无论他的表现怎样，你都永远无法判断一个人的真正人格。他有可能在他真人格的基础上发展个变化，而这个变化有几层，你自以为认清了一个人表面下的真正性格究竟是他的第几层面具？<br>那么血战钢锯岭呢？撕掉了第一层表面人格！是的，全片仅仅撕掉了第一层人格，我相信Doss的性格解析做的并没有太深入，所以当我看到他宁愿上军事法庭也不愿意拿枪的时候，给我一个突兀的感觉。在这方面，《阿甘正传》做的挺好的，怎么做到的我已经忘了，但是从头看到尾，乃至今后所做抉择都可能会被他影响。可能阿甘的人格剖析的足够彻底，以至于仿佛我们感到自己度过了他的一生。<br>或许Doss的成型并不来源于经历，而是信仰，即宗教。这真的是我所不能理解的了。我挺想成为一个虔诚的信教徒，但是越是参与宗教，越觉得我可能就是那些站在宗教对立面的原型。甚至一度怀疑自己是不是一个不知道自己是撒旦的撒旦（有点绕）。这或许解释了为什么说归属上帝的人都有福，而有些人归属了上帝却并没有福，因为你在基督的概念里并不是人。<br>Doss对于上帝的信仰无比坚定，而上帝也确实多多加福于他。可能是宗教的力量吧。毫无信仰的可怜鬼真的无比羡慕，在我的眼里，即使真的是上帝创造了我们，那么他的目的可能也只是想知道谁创造的他。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/10/04/2017-10-04-OpenVPN-study01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/2017-10-04-OpenVPN-study01/" itemprop="url">
                  OpenVPN study 01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-10-04 00:00:00" itemprop="dateCreated datePublished" datetime="2017-10-04T00:00:00+08:00">2017-10-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-14 06:05:49" itemprop="dateModified" datetime="2018-05-14T06:05:49+08:00">2018-05-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/OpenVPN/" itemprop="url" rel="index"><span itemprop="name">OpenVPN</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://linux.cn/article-3706-2.html#3_16545" target="_blank" rel="noopener">十步搭建OpenVPN，享受你的隐私生活</a></p>
<p><a href="http://blog.csdn.net/dog250/article/details/6990814" target="_blank" rel="noopener">关于OpenVPN文章的目录</a></p>
<p><a href="http://os.51cto.com/art/201107/277146.htm" target="_blank" rel="noopener">轻松构建自己的OpenVPN家庭服务器（VMware+Amahi）</a></p>
<p><a href="http://os.51cto.com/art/201311/419241.htm" target="_blank" rel="noopener">Linux上如何通过 OpenVPN 建立安全的远程连接（上）</a></p>
<p><a href="http://os.51cto.com/art/201405/439920.htm" target="_blank" rel="noopener">Ubuntu 14.04 LTS中 OpenVPN 导入功能被破坏</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/30/2017-09-30-反向代理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/2017-09-30-反向代理/" itemprop="url">
                  反向代理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-30 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-30T00:00:00+08:00">2017-09-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 09:09:16" itemprop="dateModified" datetime="2018-05-19T09:09:16+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI/" itemprop="url" rel="index"><span itemprop="name">PKI</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><h2 id="1-数据流"><a href="#1-数据流" class="headerlink" title="1 数据流"></a>1 数据流</h2><p><img src="/images/SSL5_Proxy_Reverse.png" alt="SSL5_Proxy_Reverse"></p>
<h2 id="2-数据包分析："><a href="#2-数据包分析：" class="headerlink" title="2 数据包分析："></a>2 数据包分析：</h2><p>前端抓包：本来作为对比，这里应该展示一下前端抓包，然而由于水平有限，抓取到包后才发现是SSL加密后的数据，不会解！这里先厚颜无耻的用别人的数据：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line"><span class="section">Host: 192.168.41.119:443</span></span><br><span class="line"><span class="section">Connection: keep-alive</span></span><br><span class="line"><span class="section">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="section">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36</span></span><br><span class="line">(KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36</span><br><span class="line"><span class="section">Accept:</span></span><br><span class="line">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="section">Accept-Encoding: gzip, deflate, sdch</span></span><br><span class="line"><span class="section">Accept-Language: en-US,en;q=0.8,zh-CN;q=0.6,zh;q=0.4</span></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="section">Date: Mon, 19 Jun 2017 03:55:24 GMT</span></span><br><span class="line"><span class="section">Server: Apache/2.4.7 (Ubuntu)</span></span><br><span class="line"><span class="section">X-Frame-Options: SAMEORIGIN</span></span><br><span class="line"><span class="section">X-XSS-Protection: 1; mode=block</span></span><br><span class="line"><span class="section">X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="section">Cache-Control: max-age=0, private, must-revalidate</span></span><br><span class="line"><span class="section">X-Request-Id: 2af2ebc2-9cf8-4b78-ba59-6b8b376c14a0</span></span><br><span class="line"><span class="section">X-Runtime: 0.031394</span></span><br><span class="line"><span class="section">X-Powered-By: Phusion Passenger 4.0.37</span></span><br><span class="line"><span class="section">ETag: W/"d6e7f913f28897c09387d35dd14b4a35-gzip"</span></span><br><span class="line"><span class="section">Status: 200 OK</span></span><br><span class="line"><span class="section">Vary: Accept-Encoding</span></span><br><span class="line"><span class="section">Content-Encoding: gzip</span></span><br><span class="line"><span class="section">Content-Length: 2899</span></span><br><span class="line"><span class="section">Content-Type: text/html; charset=utf-8</span></span><br><span class="line"><span class="section">Keep-Alive: timeout=15, max=100</span></span><br><span class="line"><span class="section">Connection: Keep-Alive</span></span><br></pre></td></tr></table></figure>
<p>从数据里得知，使用者发送了一个GET请求到网关（192.168.41.119:443），并得到反馈。</p>
<p>后端抓包：<code>tcpdump -i any host 192.168.1.8 -s 0 -A -w reverse-117-8.cap</code>  （相当于在上图第二根灰色虚线处设立一个数据监察点）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.0</span><br><span class="line"></span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8</span><br><span class="line"><span class="attribute">X-Forwarded-Proto</span>: https</span><br><span class="line"><span class="attribute">Max-Forwards</span>: 10</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 192.168.41.110</span><br><span class="line"><span class="attribute">X-Forwarded-Host</span>: 192.168.41.117</span><br><span class="line"><span class="attribute">X-Forwarded-Server</span>: www.mysite.com</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Wed, 20 Sep 2017 05:17:36 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.0.54 (Unix) PHP/5.0.4</span><br><span class="line"><span class="attribute">Last-Modified</span>: Mon, 20 Jun 2016 06:12:44 GMT</span><br><span class="line"><span class="attribute">ETag</span>: "1be8ec-1bbe-97b00f00"</span><br><span class="line"><span class="attribute">Accept-Ranges</span>: bytes</span><br><span class="line"><span class="attribute">Content-Length</span>: 7102</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>抓取的数据对应与图中的第7步与第8步，这里没有开启信息绑定项，所以没有<code>KOAL-CERT-CN</code>和<code>KOAL-CERT-OU</code>项，信息绑定将在<a href="">mod_uaa模块分析</a>介绍。</p>
<p>从<code>X-Forwarded-For: 192.168.41.110</code>项可以方便应用获取数据包的原始来源IP，个人估计是用来进行追踪的，如果不想被<strong>应用</strong>了解是谁通过网关访问，可能需要改动网关，使其增加<strong>隐身访问</strong>的功能，实现在设计层面很简单，就是去掉<code>X-Forwarded-For: 192.168.41.110</code>。好了，我们现在不会担心自己的访问IP被应用收集了，但是去掉该选项会不会导致从<strong>应用</strong>返回到网关的数据报无法找到回去的路，这个没有做过实验我也无法确定。</p>
<p>既然无法确定我为什么要提出这个想法，因为你看，在上面应用返回给网关的数据报中，没有包含任何有关”hi,please go to 192.168.41.110”的选项，可是网关还是顺利的完成了任务，也就是说将用户请求的数据正确的返回给用户并不是靠<code>X-Forwarded-For: 192.168.41.110</code>选项维持的。</p>
<p>至于究竟如何实现，抱歉以我目前水平无法想出方法去立刻得出答案。不过还是可以提出猜想，比如网关采取阻塞IO的方式傻傻的等。</p>
<h2 id="3-过程分析"><a href="#3-过程分析" class="headerlink" title="3 过程分析"></a>3 过程分析</h2><h3 id="3-1-客户端与网关之间的SSL握手"><a href="#3-1-客户端与网关之间的SSL握手" class="headerlink" title="3.1 客户端与网关之间的SSL握手"></a>3.1 客户端与网关之间的SSL握手</h3><p>这个过程主要涉及SSL协议，主要是为了确定双方的身份，同时利用RSA加解密的思想确定一个预主密钥，这个密钥是一个对称加密密钥，之后双方发送的数据都通过预主密钥加密发送。参见<a href="https://renzheng0403.github.io/posts/ssl/SSL-and-TLS-%E7%9F%A5%E8%AF%86%E7%82%B9.html">SSL握手</a></p>
<h3 id="3-2-数据在网关之间的修改"><a href="#3-2-数据在网关之间的修改" class="headerlink" title="3.2 数据在网关之间的修改"></a>3.2 数据在网关之间的修改</h3><p>这个过程相当于对数据的改头换面，从图中可以看出其依次经过了一条由各个模块构成的流水线：<a href="">mod_ssl</a>-&gt;<a href="https://renzheng0403.github.io/posts/mod_pmc%E6%A8%A1%E5%9D%97.html">mod_pmc</a>-&gt;<a href="">mod_uaa</a>-&gt;<a href="">mod_proxy</a>-&gt;<a href="">mod_proxy_http</a></p>
<h3 id="3-3-网关与应用之间的HTTP请求"><a href="#3-3-网关与应用之间的HTTP请求" class="headerlink" title="3.3 网关与应用之间的HTTP请求"></a>3.3 网关与应用之间的HTTP请求</h3><p>这个就不详细讲了，属于正常的HTTP请求。</p>
<h2 id="4-指令配置"><a href="#4-指令配置" class="headerlink" title="4 指令配置"></a>4 指令配置</h2><p>这个部分并不是用来阅读的，用来在后面研究模块的时候回过头来惊叹，哦，原来是这个样子！</p>
<p>proxy.conf:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">ServerRoot <span class="string">"/kssl/HRP/cfg/1"</span></span><br><span class="line">DocumentRoot <span class="string">"/kssl/HRP/cfg/htdoc"</span></span><br><span class="line">CoreDumpDirectory ./<span class="built-in">log</span></span><br><span class="line">TraceEnable off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Include     logformat.conf</span><br><span class="line">Include     server.conf</span><br><span class="line">PidFile     <span class="built-in">log</span>/HRP.pid</span><br><span class="line">ErrorLog   <span class="string">"syslog||/kssl/HRP/bin/rotatelogs /kssl/HRP/cfg/1/log/error.log 2M"</span></span><br><span class="line">LogLevel    warn</span><br><span class="line">SSLPassPhraseDialog auto</span><br><span class="line"></span><br><span class="line">SSLSessionCache shm:/kssl/HRP/cfg/<span class="number">1</span>/cache/ssl/session_cache(<span class="number">16777216</span>)</span><br><span class="line">SSLSessionCacheTimeout <span class="number">900</span></span><br><span class="line"></span><br><span class="line">Listen      <span class="number">192.168</span><span class="number">.41</span><span class="number">.119</span>:<span class="number">443</span></span><br><span class="line">ListenBacklog   <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">NameVirtualHost <span class="number">192.168</span><span class="number">.41</span><span class="number">.119</span>:<span class="number">443</span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost <span class="number">192.168</span><span class="number">.41</span><span class="number">.119</span>:<span class="number">443</span>&gt;</span><br><span class="line">    ServerName  www.mysite.com:<span class="number">443</span></span><br><span class="line">    UseCanonicalName Off</span><br><span class="line"></span><br><span class="line">    SetEnvIf Range (,.*?)&#123;<span class="number">5</span>,&#125; bad-range=<span class="number">1</span></span><br><span class="line">    RequestHeader unset Range env=bad-range</span><br><span class="line">    RequestHeader <span class="keyword">set</span> X-Forwarded-Proto <span class="comment">"https"</span></span><br><span class="line"></span><br><span class="line">    Timeout                 <span class="comment">60</span></span><br><span class="line">    KeepAlive               <span class="comment">On</span></span><br><span class="line">    MaxKeepAliveRequests    <span class="comment">1000</span></span><br><span class="line">    KeepAliveTimeout        <span class="comment">15</span></span><br><span class="line"></span><br><span class="line">    RewriteLogLevel <span class="comment">6</span></span><br><span class="line">    HostNameLookups         <span class="comment">Off</span></span><br><span class="line">    SSLEngine    <span class="comment">on</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SSLCertificateFile      <span class="comment">pem</span>/rsa.pem</span><br><span class="line">    SSLCertificateKeyFile   pem/<span class="comment">rsa.key</span></span><br><span class="line"></span><br><span class="line">    SSLCACertificatePath    <span class="comment">pem</span>/ca</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SSLCRLVerifyType none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SSLProtocol -<span class="keyword">ALL</span>  +TLSv1<span class="number">.2</span> +TLSv1<span class="number">.1</span> +TLSv1</span><br><span class="line"></span><br><span class="line">    CustomLog <span class="comment">"|/kssl/HRP/bin/rotatelogs /kssl/HRP/cfg/1/log/access.log 2M"</span> default env=!default_log_filter</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    &lt;IfModule mod_proxy.c&gt;</span><br><span class="line"></span><br><span class="line">        SetEnv force-proxy-request<span class="number">-1.0</span> <span class="number">1</span></span><br><span class="line">        SetEnv proxy-nokeepalive <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        ProxyRequests           Off</span><br><span class="line">        ProxyVia                Block</span><br><span class="line">        ProxyPreserveHost       Off</span><br><span class="line"></span><br><span class="line">    RewriteEngine On</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ProxyPass               /<span class="comment">   http:</span>//<span class="comment">192.168.1.8</span>/</span><br><span class="line">        ProxyPassReverse        /<span class="comment">   http:</span>//<span class="comment">192.168.1.8</span>/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/<span class="comment">IfModule&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/IfDefine&gt;</span><br></pre></td></tr></table></figure>
<p>访问控制配置pmc.conf:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PMCEngine <span class="keyword">On</span></span><br><span class="line">PMCControlType  Access</span><br><span class="line">PMCFilterType  Exclude</span><br><span class="line">PMCFieldUrlDecode Off</span><br><span class="line"></span><br><span class="line">PMCServiceProvider PMS http:<span class="comment">//192.168.41.115:8880/pms/check</span></span><br><span class="line">PMCUrlEncode <span class="keyword">On</span></span><br><span class="line">PMCExtendGranularity <span class="keyword">On</span></span><br><span class="line">PMCCurlTimeOut <span class="number">30</span></span><br><span class="line">PMCCurlConnectionTimeOut  <span class="number">30</span></span><br><span class="line">PMCUriPattern  *.jpg</span><br><span class="line">PMCUriPattern  *.gif</span><br><span class="line">PMCUriPattern  *.js</span><br><span class="line">PMCEncrypt Off</span><br><span class="line">PMCHeaderFieldMapping   <span class="built_in">VAR</span>:SSL_CLIENT_S_DN_CN PU:<span class="literal">CN</span></span><br><span class="line">PMCHeaderFieldMapping   <span class="built_in">VAR</span>:REMOTE_ADDR PL:IP</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/30/2017-09-30-mod_pmc模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/2017-09-30-mod_pmc模块/" itemprop="url">
                  mod_pmc模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-30 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-30T00:00:00+08:00">2017-09-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-14 06:05:49" itemprop="dateModified" datetime="2018-05-14T06:05:49+08:00">2018-05-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI/" itemprop="url" rel="index"><span itemprop="name">PKI</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-源代码结构（apache模块结构）"><a href="#1-源代码结构（apache模块结构）" class="headerlink" title="1 源代码结构（apache模块结构）"></a>1 源代码结构（apache模块结构）</h2><p>模块定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> AP_MODULE_DECLARE_DATA pmc_module = &#123;</span><br><span class="line">    STANDARD20_MODULE_STUFF,</span><br><span class="line">    pmc_create_dir_conf,      <span class="comment">/* create per-dir    config structures */</span></span><br><span class="line">    pmc_merge_dir_conf,       <span class="comment">/* merge  per-dir    config structures */</span></span><br><span class="line">    pmc_create_server_conf,   <span class="comment">/* create per-server config structures */</span></span><br><span class="line">    pmc_merge_server_conf,    <span class="comment">/* merge  per-server config structures */</span></span><br><span class="line">    pmc_cmds,                 <span class="comment">/* table of config file commands       */</span></span><br><span class="line">    pmc_register_hooks        <span class="comment">/* register hooks                      */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注册钩子处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pmc_register_hooks</span><span class="params">(<span class="keyword">apr_pool_t</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 注册可选函数 */</span></span><br><span class="line">    APR_REGISTER_OPTIONAL_FN(pmc_check_fail);</span><br><span class="line">    APR_REGISTER_OPTIONAL_FN(pmc_query_attrs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 日志 */</span></span><br><span class="line">    ap_hook_pre_config(pmc_hook_pre_config, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_MIDDLE);</span><br><span class="line">    <span class="comment">/* 初始化连接上下文 */</span></span><br><span class="line">    ap_hook_pre_connection(pmc_pre_connection, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_MIDDLE);</span><br><span class="line">    <span class="comment">/* 检查权限 */</span></span><br><span class="line">    ap_hook_access_checker(pm_permission_check, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_FIRST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指令配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> command_rec pmc_cmds[] =</span><br><span class="line">&#123;</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCEngine"</span>, cmd_pmc_engine, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc engine On or Off"</span>),</span><br><span class="line">    AP_INIT_FLAG(<span class="string">"PMCEngineSkip"</span>, cmd_pmc_engine_skip, <span class="literal">NULL</span>, ACCESS_CONF, <span class="string">"set if pmc is skipped"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCCurlTimeOut"</span>, cmd_pmc_curl_timeout, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc curl timeout"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCCurlConnectionTimeOut"</span>, cmd_pmc_curl_connection_timeout, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc curl connection timeout"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCControlType"</span>, cmd_pmc_control_type, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc control type(Connect or Access)"</span>),</span><br><span class="line">    AP_INIT_TAKE23(<span class="string">"PMCServiceProvider"</span>, cmd_pmc_service_provider, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc service provider and uri"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCExtendGranularity"</span>, cmd_pmc_granularity_extend, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc entend granularity On or Off"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCUrlEncode"</span>, cmd_pmc_urlencode, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc urlencode On or Off"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCEncrypt"</span>, cmd_pmc_encrypt, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc encrypt  On or Off"</span>),</span><br><span class="line">    AP_INIT_TAKE2(<span class="string">"PMCEncryptAlgorithm"</span>, cmd_pmc_encrypt_algorithm, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc encrypt algorithm"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCFieldUrlDecode"</span>, cmd_pmc_field_urldecode, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc field urldecode On or Off"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCUriPattern"</span>, cmd_pmc_uri_pattern, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc uri pattern"</span>),</span><br><span class="line">    AP_INIT_TAKE1(<span class="string">"PMCUriRegex"</span>, cmd_pmc_uri_regex, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc uri regex"</span>),</span><br><span class="line">    AP_INIT_TAKE23(<span class="string">"PMCHeaderFieldMapping"</span>, cmd_pmc_header_field_mapping, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc header field mapping"</span>),</span><br><span class="line">    AP_INIT_TAKE2(<span class="string">"PMCUrlFieldMapping"</span>, cmd_pmc_url_field_mapping, <span class="literal">NULL</span>, RSRC_CONF, <span class="string">"set pmc url field mapping"</span>),</span><br><span class="line"></span><br><span class="line">    &#123;<span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>指令用于在配置文件中设定值。</p>
<p>我自己认为apache这套系统在功能<strong>实现</strong>和<strong>控制</strong>两个方面做的很清晰，在钩子处理函数里面，实现的是业务逻辑，使用的人如果想更改其中的某些选项或者方式，那么只需要通过指令做相应的配置就可以了，即控制。我们想一想魔法世界，巫师并不清楚魔法世界的运作原理，但是使用魔杖念出魔咒，就可以发挥神奇的功效。Apache的指令就是我们的魔咒。还可以自己创造<strong>魔咒</strong>，只要在<code>command_rec pmc_cmds[]</code>里配置并编写相应的函数就能完成。</p>
<p>什么是功能<strong>实现</strong>呢？目前我能想到的和这个系统最像的就是集成电路的制备过程，模块和参数控制，硅片在这个流程里被加工成集成电路，而通过改变设定的参数，你可以控制渗透多少元素或者腐蚀到什么程度。但是这个比喻不好，因为了解这个的人不多。现实中也有同样的例子，或许社会学家就有更形象的例子。</p>
<p>数据来到了这个<code>mod_pmc</code>模块，我想将其设置为接入控制，不需要去分析源代码，改动源代码的结构，只需要在专门设置访问控制的配置文件pmc.conf文件里设置：<code>PMCControlType  Access</code>就可以了。那么接下来在名为<code>PMCControlType  Access</code>的黑盒后面发生了什么？</p>
<p>顺藤摸瓜，在指令配置<code>static const command_rec pmc_cmds[]</code>里发现了<code>AP_INIT_TAKE1(&quot;PMCControlType&quot;, cmd_pmc_control_type, NULL, RSRC_CONF, &quot;set pmc control type(Connect or Access)&quot;),</code>，线索很明确了，<code>cmd_pmc_control_type</code>就是我们下一步要去探访的<strong>函数</strong>，此行吉凶未知，万一他什么也不说，只是给出一副冷冰冰的黑脸怎么办。</p>
<p>我们的在同一个文件<strong>mod_pmc.c</strong>里找到了<code>cmd_pmc_control_type</code>老兄，结果却异常顺利，原来设想的”我不知道啊，某某告诉我的，你去他那里看看“这种对话并没有出现。<code>cmd_pmc_control_type</code>老兄一看就是个实在人，告诉了我他的工作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">cmd_pmc_control_type</span><span class="params">(cmd_parms *params, <span class="keyword">void</span> *dummy, <span class="keyword">const</span> <span class="keyword">char</span> *control_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pmc_module_conf *mconf = ap_get_module_config(params-&gt;server-&gt;module_config, &amp;pmc_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(control_type, <span class="string">"Connect"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        mconf-&gt;control_type = CT_CONNECT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(control_type, <span class="string">"Access"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        mconf-&gt;control_type = CT_ACCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> apr_psprintf(params-&gt;pool, <span class="string">"%s is an invalid control type, must be Connect or Access"</span>, control_type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>诺，你看，<code>control_type</code>的值也就是<code>cmd_pmc_control_type</code>的值自然是<code>Access</code>，由此将设置<code>mconf-&gt;control_type</code>的值为<code>CT_ACCESS</code>，但是老兄隐藏了<code>ap_get_module_config</code>的线索，我使用人肉搜索也没有找到。包括<code>cmd_params *params</code>参数也没有提供来源，这不重要。重要的是，在钩子处理函数<code>pm_permission_check</code>里看到的通过<code>switch (mconf-&gt;control_type)</code>进行判断有了合理的解释，<code>mconf-&gt;control_type</code>果然是设置好的值，但是与我之前的猜测甚远，并不是在另外某个函数里故意设置的，真相只有一个，那就是<code>cmd_pmc_control_type</code>老兄干的！（此刻响起了名侦探柯南破案成功的音乐）</p>
<p>不要高兴太早，我们还只理清了这个模块的指令的其中一个的实现，举这个例子只是想理清这个模块的架构的大致模样：钩子处理函数处理数据的主要流程，指令注册的函数则对某些参数进行改变，接下来的部分的思路就分两块进行了。</p>
<h2 id="2-钩子处理函数"><a href="#2-钩子处理函数" class="headerlink" title="2 钩子处理函数"></a>2 钩子处理函数</h2><h3 id="2-1-pm-permission-check"><a href="#2-1-pm-permission-check" class="headerlink" title="2.1 pm_permission_check"></a>2.1 <code>pm_permission_check</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: pm_permission_check</span><br><span class="line">e=&gt;end: return DECLINED</span><br><span class="line">mconf=&gt;operation: mconf = ap_get_module_config(server-&gt;module_config, &amp;pmc_module);</span><br><span class="line">dconf=&gt;operation: dconf = ap_get_module_config(r-&gt;per_dir_config, &amp;pmc_module);</span><br><span class="line">ret=&gt;operation: ret</span><br><span class="line">finish_check=&gt;operation: finish_check</span><br><span class="line">curl=&gt;operation: curl_handle = curl_easy_init();</span><br><span class="line">rconf=&gt;operation: rconf = pmc_create_request_conf(r-&gt;pool);</span><br><span class="line">mconf_service_provider=&gt;operation: mconf-&gt;service_provider//检测服务提供者</span><br><span class="line"></span><br><span class="line">mconf_enable=&gt;condition: mconf-&gt;enable</span><br><span class="line">dconf_skip=&gt;condition: dconf-&gt;skip</span><br><span class="line">mconf_service=&gt;condition: uri == NULL</span><br><span class="line">mconf_control_type=&gt;condition: mconf-&gt;control_type == CT_CONNECT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">st-&gt;mconf-&gt;mconf_enable</span><br><span class="line">mconf_enable(no, bottom)-&gt;dconf</span><br><span class="line">mconf_enable(yes)-&gt;ret</span><br><span class="line">dconf-&gt;dconf_skip</span><br><span class="line">dconf_skip(yes)-&gt;e</span><br><span class="line">dconf_skip(no, bottom)-&gt;mconf_service</span><br><span class="line">mconf_service(yes)-&gt;e</span><br><span class="line">mconf_service(no, bottom)-&gt;curl</span><br><span class="line">curl-&gt;rconf</span><br><span class="line">rconf-&gt;mconf_control_type</span><br><span class="line">mconf_control_type(yes)-&gt;finish_check</span><br><span class="line">mconf_control_type(no, bottom)-&gt;mconf_service_provider</span><br></pre></td></tr></table></figure>
<p>浩浩荡荡画了这么长flowchar，我决定放弃了，开始是画图比读代码容易理解，此刻画图却成了折磨，还是读代码爽啊。</p>
<p>检查服务提供者算是第一道比较重要的关卡，<code>mconf-&gt;service_provider</code>有三种可能的值：</p>
<ul>
<li><p>SP_LOCAL:</p>
<p>check_permission_with_local(r, mconf)</p>
</li>
<li><p>SP_MTSMS:</p>
<p>check_permission_with_mtsms(r, mconf, curl_handler, new_url)</p>
</li>
<li><p>SP_TJJMS:</p>
<p>mconf-&gt;control_type</p>
<ul>
<li><p>CT_CONNECT</p>
<p>check_permission_with_tjjms(r, mconf, curl_handle, new_url)</p>
</li>
<li><p>CT_ACCESS</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/27/2017-09-27-TensorFlow-Study-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/27/2017-09-27-TensorFlow-Study-01/" itemprop="url">
                  TensorFlow Study 01
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-27 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-27T00:00:00+08:00">2017-09-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-14 06:05:49" itemprop="dateModified" datetime="2018-05-14T06:05:49+08:00">2018-05-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/deeplearn/" itemprop="url" rel="index"><span itemprop="name">deeplearn</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>TensorFlow守则</strong></p>
<ul>
<li>使用<code>图（graph）</code>来表示计算任务</li>
<li>在被称之为<code>会话（Session）</code>的上下文（context）中执行图</li>
<li>使用<code>tensor</code>表示数据</li>
<li>通过<code>变量（Variable）</code>维护状态</li>
<li>使用feed和fetch可以为任意的操作（arbitrary operation）赋值或者从其中获取数据</li>
</ul>
<p>所谓守则就是不明白为什么，不一定要遵守，但是一定要会背的东西，附上2015修订版中小学生守则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">爱党爱国爱人民。</span><br><span class="line">好学多问肯钻研。</span><br><span class="line">勤劳笃行乐奉献。</span><br><span class="line">明礼守法讲美德。</span><br><span class="line">孝亲尊师善待人。</span><br><span class="line">诚实守信有担当。</span><br><span class="line">自强自律健身心。</span><br><span class="line">珍爱生命保安全。</span><br><span class="line">勤俭节约护家园。</span><br></pre></td></tr></table></figure></p>
<p>这么一对比，是不是就明白了<strong>TensorFlow守则</strong>对于目前处于0系列学习阶段的我们意味着什么。</p>
<p>在完全不明白的情况下，用自己的话复述一遍毫无意义，接下来我就为大家复述一遍:)。</p>
<p>TensorFlow的一个<strong>图</strong>就可以代表一个计算的任务，这里的<strong>图</strong>很明显不是picture的含义，我们有必要附上一下<strong>graph</strong>的英语解释：</p>
<blockquote>
<p>a planned dawing, consisting of a line or lines, showing how two or more sets of numbers are related to each other</p>
</blockquote>
<p>试着翻译成英式汉语：</p>
<blockquote>
<p>一个计划图，包含一些线，展示给我们两个或多个数集是如何互相关联。</p>
</blockquote>
<p>这个<strong>图</strong>就是线性图的简称了，但是最开始不明所以的时候给我造成了潜意识的理解困难。用流程图更好解释，与图画等区分开。</p>
<p><strong>会话</strong>同样给我带来了误导，我现在倾向于认为此<strong>Session</strong>与TCP/IP里的<strong>session</strong>风马牛不相及，相不相及我说了不算，还是附上<strong>session</strong>的权威解释（我的<strong>微软必应词典</strong>是这么信心十足的告诉我的，好了，乱入什么广告，微软又不给钱）：</p>
<blockquote>
<ol>
<li>a period of time that is spent doing a particular activity</li>
<li>a formal meeting or series of meetings of a count, a parliament, etc.; a period of time when such meetings are held</li>
<li>a school or university year</li>
<li>an occasion whrn people meet to play music, especially lrish music, in a pub/bar</li>
</ol>
</blockquote>
<p>个人觉得后面三个是无关紧要的释意，但是论文养成的凑字数的毛病尽显无遗，博客应该简洁……</p>
<p>Session被强行翻译成<strong>会话</strong>，仿佛让我闻到了0X2D的味道。网络里的session翻译成<strong>会话</strong>无可厚非，意思是这个值用来从保持 a period of time that is spent doing a <strong>talk</strong>，抽象的理解为维持一段会话，但是TensorFlow这个Session是 a period of time that is spent doing a <strong>count</strong>，如此这般还要翻译成<strong>会话</strong>，不妥。</p>
<p>tensor的解释我只能照搬<strong>权威</strong>的解释：</p>
<blockquote>
<p>a muscle that tightens or stretches part of the body</p>
</blockquote>
<p>How are you? I’m fine, fuck you!</p>
<p>我只能默默地看了看日渐雄起的弘二头肌，hi,tensor。</p>
<p>一个略显牵强的联想：<code>tensor-&gt;张肌-&gt;张量-&gt;张与缩-&gt;变化-&gt;变量-&gt;数据</code>，也不知道是不是这样理解，但是不可否认，这个tensor代表了月之阴晴圆缺，人之悲欢离合。变化需要值来量化,也就是数据。tensor数据结构用来在op剑传递，你可以将它看做一个n维的数组或列表。</p>
<p>tensor组成：</p>
<ul>
<li>rank静态类型</li>
<li>shape</li>
<li>type</li>
</ul>
<p>至于Variable…日渐难以自圆其说了，上<strong>权威</strong>：</p>
<blockquote>
<p>a situation, number or quantity that can vary or be vried</p>
</blockquote>
<p>这个数或者说量，就是用来维持状态（？）的</p>
<p>feed（喂）和fetch（拉取）用来在图的执行过程中赋值和获取数据。</p>
<p>TensorFlow守则就讲到这里了。用教程里的一句话总结：</p>
<blockquote>
<p>一个TensorFlow图<em>graph</em>描述了计算的过程。为了计算，图必须在<code>Session</code>里被启动。<code>Session</code>将图的op分发到诸如CPU或GPU的设备上，同时提供执行op的方法。这些方法执行后，将产生的tensor返回。</p>
</blockquote>
<p>接下来我们将正式进入到幼儿园阶段的学习，也就是0系列。大部分的人都和我一样，必须要将自己作为一个黑箱，不断地输入数据，这个过程只能尽力去理解，但是本质上一无所知。我们只能依靠不断地输入，来调整自己的神经通路，最终达到理解的目的。这和深度学习有异曲同工之妙。下面的内容分为两部分，构建图，执行图。做到就OK了。另外，鉴于我对这个翻译的极度不满，将对部分名词使用原生英语代替。</p>
<h2 id="构建graph"><a href="#构建graph" class="headerlink" title="构建graph"></a>构建graph</h2><p>graph的构建由op（操作节点）组成，op由输入、构造器、输出组成，当然第一个op即源op不需要任何输入。例子如下：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import tensorflow as tf</span><br><span class="line"></span><br><span class="line"># 创建一个常量op，产生一个<span class="number">1</span>x2矩阵</span><br><span class="line"># constant应该就是一个常量构造器</span><br><span class="line">matrix1 = tf.constant(<span class="string">[[3., 3.]]</span>)</span><br><span class="line"># 创建另一个常量构造器，产生一个<span class="number">2</span>x1矩阵</span><br><span class="line">matrix2 = tf.constant(<span class="string">[[2.], [2.]]</span>)</span><br><span class="line"></span><br><span class="line"># 这里创建了一个执行矩阵乘法的matmul op，上面的两个op的输出作为本op的输入</span><br><span class="line">product = tf.matmul(matrix1, matrix2)</span><br></pre></td></tr></table></figure></p>
<h2 id="启动graph"><a href="#启动graph" class="headerlink" title="启动graph"></a>启动graph</h2><p>我们已经构造好了，接下来需要执行启动。我们创建一个<code>Session</code>对象，由该对象执行操作。嗯，对象，没有错，<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建对象</span></span><br><span class="line">sess = tf.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用run触发op的执行</span></span><br><span class="line">result = sess.run(product)</span><br><span class="line">print result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务完成，关闭Session</span></span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure></p>
<p><code>run</code>触发了三个op并发执行，这点耐人寻味，不知是否是制作教程的人理解错误还是TensorFlow果有此能耐，毕竟第三个矩阵乘法在没有取得输入的情况下如何执行，如果真的是这种情况，那么就应了郭光灿院士的话，量子计算机将给深度学习带来突破瓶颈的进展，因为量子计算机的多态计算很适合此并发。</p>
<h2 id="交互式Session"><a href="#交互式Session" class="headerlink" title="交互式Session"></a>交互式Session</h2><p>上面的例子我们使用Session对象来启动garph，面向对象编程大家都有经验<br>下面的方法使用<code>InteractiveSession</code>代替<code>Session</code>类，使用<code>Tensor.eval()</code>和<code>Operation.run()</code>方法代替<code>Session.run()</code>，这么做据说是为了便于用于IPython之类的交互环境：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入一个交互式 TensorFlow 会话.</span></span><br><span class="line">import tensorflow as tf</span><br><span class="line">sess = tf.InteractiveSession()</span><br><span class="line"></span><br><span class="line">x = tf.Variable([1.0, 2.0])</span><br><span class="line">a = tf.constant([3.0, 3.0])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用初始化器 initializer op 的 run() 方法初始化 'x' </span></span><br><span class="line">x.initializer.run()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加一个减法 sub op, 从 'x' 减去 'a'. 运行减法 op, 输出结果 </span></span><br><span class="line">sub = tf.sub(x, a)</span><br><span class="line">print sub.eval()</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/20/2017-09-20-TensorFlow-Study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/20/2017-09-20-TensorFlow-Study/" itemprop="url">
                  TensorFlow Study
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-20 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-20T00:00:00+08:00">2017-09-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-14 06:05:49" itemprop="dateModified" datetime="2018-05-14T06:05:49+08:00">2018-05-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/deeplearn/" itemprop="url" rel="index"><span itemprop="name">deeplearn</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本来是打算继续背诵枯燥的PKI，奈何google大大普及了TensorFlow，这么好玩的东西确定不玩玩吗。那不能。</p>
<p>完全不知道该怎么入手，就找了几篇记录看看：<br>首先当然是<a href="http://www.tensorfly.cn/" target="_blank" rel="noopener">TensorFlow中文社区</a>，初级教程讲解的这么详细，先收藏起来多看几遍吧</p>
<p>其次是技术模板类的傻瓜教程-<a href="https://www.leiphone.com/news/201606/ORlQ7uK3TIW8xVGF.html" target="_blank" rel="noopener">真正从零开始，TensorFlow详细安装入门图文教程</a>，不懂得时候跟着做一遍。<br>SI3US-664965-05156</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/19/2017-09-19-正向代理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/2017-09-19-正向代理/" itemprop="url">
                  正向代理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-19 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-19T00:00:00+08:00">2017-09-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 09:05:23" itemprop="dateModified" datetime="2018-05-19T09:05:23+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI/" itemprop="url" rel="index"><span itemprop="name">PKI</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-正向代理原理"><a href="#1-正向代理原理" class="headerlink" title="1 正向代理原理"></a>1 正向代理原理</h1><p>为了从原始服务器获取内容，客户端向代理发送一个请求并指定目标，然后代理向原始服务器转发请求，并将获得的内容返回给客户端。如<img src="/images/proxy-forward.png" alt="图2"></p>
<h1 id="2-网关产品正向代理原理"><a href="#2-网关产品正向代理原理" class="headerlink" title="2 网关产品正向代理原理"></a>2 网关产品正向代理原理</h1><p>关键业务流程如下图：<br><img src="/images/SSL5_Proxy_Forward.png" alt=""></p>
<p>与反向代理不同，我接触的正向代理配合客户端使用，第一步往往需要开启客户端，然后通过浏览器输入访问地址，发送请求。客户端截获请求，完成与网关的SSL handshark，通过SSL通道发往网关，网关根据策略发往相应的服务器，再将得到的回应发往客户端。<br>具体步骤如下：</p>
<h2 id="2-1-客户端启动，通过TUNNEL协议下载策略："><a href="#2-1-客户端启动，通过TUNNEL协议下载策略：" class="headerlink" title="2.1 客户端启动，通过TUNNEL协议下载策略："></a>2.1 客户端启动，通过TUNNEL协议下载策略：</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TUNNEL <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> HTTP<span class="regexp">/1.0      /</span><span class="regexp">/TUNNEL 地址:端口 应用协议名称/</span>版本</span><br><span class="line"><span class="string">ClientVer:</span> <span class="number">5.3</span><span class="number">.0</span>               <span class="comment">//客户端向服务端传递自身的版本号</span></span><br><span class="line"><span class="string">ClientEngine:</span> CSPEngine.dll    <span class="comment">//客户端向服务端传递自身使用的加密引擎</span></span><br><span class="line"><span class="string">Application:</span> Iexplorer.exe     <span class="comment">//客户端向服务端传递使用当前VPN通道的应用进程，用于服务端进行访问控制</span></span><br><span class="line"><span class="string">ClientPollcyRequest:</span>All        <span class="comment">//（用于客户端请求下载策略）</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2-服务端通过TUNNEL协议返回策略："><a href="#2-2-服务端通过TUNNEL协议返回策略：" class="headerlink" title="2.2 服务端通过TUNNEL协议返回策略："></a>2.2 服务端通过TUNNEL协议返回策略：</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP <span class="number">200</span> Connection Established</span><br><span class="line">Proxy-<span class="string">agent:</span> SSL/<span class="number">5.</span>x.x</span><br><span class="line"><span class="string">AppControl:</span> allow</span><br><span class="line"><span class="string">ClientPolicy:</span> CertMode<span class="regexp">/NO_PROXY_CERT   /</span>/（用于服务端向客户端下发策略）应用进程名称 目标地址 目标端口 应用协议 是否启用</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Windows下可以通过以下路径查看客户端策略：</p>
<p><code>%AppData%\koal\SSLClient\ProxyRules.txt</code>:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.109</span><span class="number">.109</span> <span class="number">80</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.98</span> <span class="number">443</span> obverse</span><br><span class="line"><span class="number">192.168</span><span class="number">.41</span><span class="number">.96</span> <span class="number">80</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.98</span> <span class="number">443</span> obverse</span><br></pre></td></tr></table></figure></p>
<p>该策略表明使用192.168.41.98:443正向代理192.168.109.109:80和192.168.41.96:80。<br><code>%ProgramData%\SSLClient\RedirectRules.txt</code>:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"*"</span> <span class="number">192.168</span><span class="number">.109</span><span class="number">.109</span> <span class="number">80</span> TCP Enable</span><br><span class="line"><span class="string">"*"</span> <span class="number">192.168</span><span class="number">.41</span><span class="number">.96</span> <span class="number">80</span> TCP Enable</span><br></pre></td></tr></table></figure></p>
<h3 id="3-浏览器直接访问"><a href="#3-浏览器直接访问" class="headerlink" title="3 浏览器直接访问"></a>3 浏览器直接访问</h3><p>想要访问192.168.1.8，发送一个HTTP GET请求：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.8</span><br></pre></td></tr></table></figure></p>
<p>这个请求被LSP截获发往SSL客户端。</p>
<h3 id="4-客户端通过TUNNEL协议传递信息"><a href="#4-客户端通过TUNNEL协议传递信息" class="headerlink" title="4 客户端通过TUNNEL协议传递信息"></a>4 客户端通过TUNNEL协议传递信息</h3><p>主要传递目标信息和额外的变量信息<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TUNNEL</span> <span class="string">192.168.1.8:80</span> HTTP/1.0</span><br><span class="line"><span class="attribute">Application</span>: iexplorer.exe</span><br><span class="line"><span class="attribute">ClientPolicyRequest</span>: None</span><br><span class="line"><span class="attribute">Variable</span>: MAC=00:11:32:1c:7c:cb</span><br></pre></td></tr></table></figure></p>
<h3 id="5-SSL客户端与网关完成SSL握手"><a href="#5-SSL客户端与网关完成SSL握手" class="headerlink" title="5 SSL客户端与网关完成SSL握手"></a>5 SSL客户端与网关完成SSL握手</h3><p>完整的握手流程参见<a href="https://github.com/renzheng0403/renzheng0403.github.io/blob/master/_posts/2016-09-09-SSL-and-TLS-%E7%9F%A5%E8%AF%86%E7%82%B9.md" target="_blank" rel="noopener">SSL与TLS知识点</a></p>
<h3 id="6-在SSL上发送业务数据"><a href="#6-在SSL上发送业务数据" class="headerlink" title="6 在SSL上发送业务数据"></a>6 在SSL上发送业务数据</h3><figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP 200 IK</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="attribute">Content-Length</span>: 256</span><br></pre></td></tr></table></figure>
<h3 id="7-SSL数据解密"><a href="#7-SSL数据解密" class="headerlink" title="7 SSL数据解密"></a>7 SSL数据解密</h3><p>mod_ssl</p>
<h3 id="8-访问控制"><a href="#8-访问控制" class="headerlink" title="8 访问控制"></a>8 访问控制</h3><p>mod_pmc或mod_ssl_acl_sqlite</p>
<h3 id="9-信息绑定"><a href="#9-信息绑定" class="headerlink" title="9 信息绑定"></a>9 信息绑定</h3><p>mod_uaa或mod_ssl</p>
<h3 id="10-数据转发"><a href="#10-数据转发" class="headerlink" title="10 数据转发"></a>10 数据转发</h3><p>mod_proxy</p>
<p>mod_proxy_http</p>
<h3 id="11-网关发送明文数据到应用服务器"><a href="#11-网关发送明文数据到应用服务器" class="headerlink" title="11 网关发送明文数据到应用服务器"></a>11 网关发送明文数据到应用服务器</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.1.8</span><br><span class="line"><span class="attribute">KOAL-CERT-CN</span>: 张三</span><br><span class="line"><span class="attribute">KOAL-CERT-OU</span>: 技术部</span><br><span class="line"><span class="attribute">KOAL-CLIENT-MAC</span>: 00:11:32:1c:7c:cb</span><br></pre></td></tr></table></figure>
<h3 id="12-应用服务器返回业务数据"><a href="#12-应用服务器返回业务数据" class="headerlink" title="12 应用服务器返回业务数据"></a>12 应用服务器返回业务数据</h3><figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP 200 OK</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="attribute">Content-Length</span>:256</span><br></pre></td></tr></table></figure>
<h3 id="13-记录访问日志"><a href="#13-记录访问日志" class="headerlink" title="13 记录访问日志"></a>13 记录访问日志</h3><p>mod_log_config</p>
<p>关于访问控制，可以通过本地配置策略，也可以从权限服务器下载</p>
<h4 id="本地访问控制"><a href="#本地访问控制" class="headerlink" title="本地访问控制"></a>本地访问控制</h4><p>配置举例：<br>acl_localdb.conf:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ACLLocalDBEngine On</span><br><span class="line">ACLLocalDBControlType  Access</span><br><span class="line">ACLLocalDBFilterType  Exclude</span><br><span class="line">ACLLocalDBUriPattern *.jpg</span><br><span class="line">ACLLocalDBUriPattern *.gif</span><br><span class="line">ACLLocalDBUriPattern *.js</span><br><span class="line">ACLLocalDBParam APPS_DB_PATH /kssl/HRP/cfg/default/apps.db</span><br><span class="line">ACLLocalDBParam USER_DB_PATH /kssl/WEBUI/www/global/global_user.db</span><br><span class="line">ACLLocalDBParam SQLITE_JOURNAL_MODE <span class="string">"MEMORY"</span></span><br><span class="line"></span><br><span class="line">ACLLocalDBParam SQLITE_BUSY_TIMEOUT_MS <span class="number">3000</span></span><br><span class="line">ACLLocalDBAutoReloadFallbackOnFailure On</span><br><span class="line">ACLLocalDBAutoReloadPolicy ByFileStat</span><br></pre></td></tr></table></figure></p>
<h4 id="外部访问控制"><a href="#外部访问控制" class="headerlink" title="外部访问控制"></a>外部访问控制</h4><p>通过从权限服务器下载控制策略，例如我接触到的ASMG，从ASMP下载控制策略：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">HEAD</span> <span class="string">/pms/check</span> HTTP/1.0</span><br><span class="line"><span class="attribute">Host</span>: 192.168.41.115:8880</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">PU</span>: CN=%c8%ce%d5%fd;CIP=192.168.41.110;OU=%bc%bc%ca%f5%c6%bd%cc%a8</span><br><span class="line"><span class="attribute">PL</span>: IP=192.168.41.110</span><br><span class="line"><span class="attribute">PR</span>: granularity=service;granularity=uri;granularity=network;uri=tcp:%2f%2f192.168.41.96:80</span><br><span class="line"><span class="attribute">PO</span>: UrlEncode=Yes</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">403</span> Forbidden</span><br><span class="line"><span class="attribute">Date</span>: Wed, 18 Jan 2017 16:47:26 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.2.16 (Debian)</span><br><span class="line"><span class="attribute">PE</span>: ecode=2; edesc=............</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=iso-8859-1</span><br></pre></td></tr></table></figure></p>
<p>以上通过对ASMP的抓包分析得到：<code>tcpdump -i any host 192.168.41.115 -s 0 -A -w pmcconf.cap</code>。</p>
<p>配置举例：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PMCEngine <span class="keyword">On</span></span><br><span class="line">PMCControlType  Access</span><br><span class="line">PMCFilterType  Exclude</span><br><span class="line">PMCFieldUrlDecode Off</span><br><span class="line"></span><br><span class="line">PMCServiceProvider PMS http:<span class="comment">//:8880/pms/check</span></span><br><span class="line">PMCUrlEncode <span class="keyword">On</span></span><br><span class="line">PMCExtendGranularity <span class="keyword">On</span></span><br><span class="line">PMCCurlTimeOut <span class="number">30</span></span><br><span class="line">PMCCurlConnectionTimeOut  <span class="number">30</span></span><br><span class="line">PMCUriPattern  *.jpg</span><br><span class="line">PMCUriPattern  *.gif</span><br><span class="line">PMCUriPattern  *.js</span><br><span class="line">PMCEncrypt Off</span><br><span class="line">PMCHeaderFieldMapping   <span class="built_in">VAR</span>:SSL_CLIENT_S_DN_CN PU:<span class="literal">CN</span></span><br><span class="line">PMCHeaderFieldMapping   <span class="built_in">VAR</span>:REMOTE_ADDR PL:IP</span><br></pre></td></tr></table></figure></p>
<h3 id="14-在SSL上返回业务数据"><a href="#14-在SSL上返回业务数据" class="headerlink" title="14 在SSL上返回业务数据"></a>14 在SSL上返回业务数据</h3><figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP 200 OK</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html</span><br><span class="line"><span class="attribute">Content-Length</span>:256</span><br></pre></td></tr></table></figure>
<h2 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h2><ul>
<li>前端正向(IE代理) + 后端正向模式<br><img src="/images/SSL5_HttpProxy_IEForward.png" alt=""></li>
<li>前端正向(LSP) + 后端正向模式<br><img src="/images/SSL5_HttpProxy_LSPForward.png" alt=""></li>
<li>使用二级代理的HTTP请求处理流程<br><img src="/images/SSL5_HttpProxy_ProxyRemote.png" alt=""></li>
<li>使用二级代理的HTTPS请求处理流程<br><img src="/images/SSL5_HttpProxy_HttpsProxyRemote.png" alt=""></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/10/2017-09-10-量子与通信/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/10/2017-09-10-量子与通信/" itemprop="url">
                  量子与通信
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-10 20:50:00" itemprop="dateCreated datePublished" datetime="2017-09-10T20:50:00+08:00">2017-09-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 09:03:58" itemprop="dateModified" datetime="2018-05-19T09:03:58+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/量子通信/" itemprop="url" rel="index"><span itemprop="name">量子通信</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天抽空看了一下公司里的一份培训资料——《量子计算和量子通信》，突然觉得自己可能确实正处于某项新技术的萌芽状态。比如Internet最开始也不过是实验室里的小范围产物而已，研究者们认为它可能会方便交流，但是当时的人们也许只会想，这东西能有什么用呢？</p>
<p>再早一点，法拉第演示电磁感应的时候不也是遇到了同样的疑问吗？而现如今也有一种技术，它的理论已经被提出，目前还是实验室的产物，会被人问这东西有什么用，我觉得应该就是量子计算了。在我刚来实习的时候，这个培训的人——毛博士还在，是个和蔼可亲的小伙子，还和他讨论过股票，但是等我做完毕设回到公司的时候，毛博士已经离职了。但是对于量子计算的学习不能停止，如果可能的话，我希望能够追赶一下这趟车，能追多远是多远。</p>
<p>这就是为什么要写这篇博客，对于如何去建立自己的学习体系，没有一点底，自己的《量子物理》当年也是可耻的挂了，从此开始了<strong>可耻纪元</strong>。高等数学-&gt;复变函数-&gt;量子物理，这些是了解量子计算和量子通信的基本工具，虽然很不情愿，但为了量子计算机，也只能硬着头皮去学了，被时代抛弃真的是很不情愿。<br>下面的内容都是毫无头脑的简单积累，不涉及科学系统学习。</p>
<h1 id="一-量子力学基础"><a href="#一-量子力学基础" class="headerlink" title="一 量子力学基础"></a>一 量子力学基础</h1><h2 id="1-量子态的叠加（干涉）性"><a href="#1-量子态的叠加（干涉）性" class="headerlink" title="1 量子态的叠加（干涉）性"></a>1 量子态的叠加（干涉）性</h2><h2 id="2-量子纠缠性"><a href="#2-量子纠缠性" class="headerlink" title="2 量子纠缠性"></a>2 量子纠缠性</h2><h2 id="3-量子不可克隆性定理"><a href="#3-量子不可克隆性定理" class="headerlink" title="3 量子不可克隆性定理"></a>3 量子不可克隆性定理</h2><h2 id="4-量子不确定性原理"><a href="#4-量子不确定性原理" class="headerlink" title="4 量子不确定性原理"></a>4 量子不确定性原理</h2><h1 id="二-量子计算"><a href="#二-量子计算" class="headerlink" title="二 量子计算"></a>二 量子计算</h1><h2 id="1-shor算法"><a href="#1-shor算法" class="headerlink" title="1 shor算法"></a>1 shor算法</h2><h2 id="2-Grover算法"><a href="#2-Grover算法" class="headerlink" title="2 Grover算法"></a>2 Grover算法</h2><h1 id="三-量子密钥分发（QKD）"><a href="#三-量子密钥分发（QKD）" class="headerlink" title="三 量子密钥分发（QKD）"></a>三 量子密钥分发（QKD）</h1><h2 id="1-BB84协议"><a href="#1-BB84协议" class="headerlink" title="1 BB84协议"></a>1 BB84协议</h2><h2 id="2-E91协议"><a href="#2-E91协议" class="headerlink" title="2 E91协议"></a>2 E91协议</h2><h2 id="附"><a href="#附" class="headerlink" title="附"></a>附</h2><p>Quantum Secret Sharing<br>Quantum Coin Tossing<br>Quantum Bit Commitment<br>Quantum Public-Key Cryptosystem</p>
<h1 id="四-课外阅读"><a href="#四-课外阅读" class="headerlink" title="四 课外阅读"></a>四 课外阅读</h1><p><a href="http://peterhs.blog.51cto.com/6318839/1104560" target="_blank" rel="noopener">量子计算机编程原理简介 和 机器学习</a></p>
<p><a href="http://open.163.com/special/cuvocw/liangzijishu.html" target="_blank" rel="noopener">中国科学技术大学公开课：来自量子世界的新技术</a></p>
<p><a href="http://blog.csdn.net/column/details/16030.html" target="_blank" rel="noopener">量子力学及量子计算</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/22306837" target="_blank" rel="noopener">从量子力学到量子卫星：如何在量子科学领域谈笑风生|袁岚峰</a></p>
<p><a href="http://www.quantum-comm.com/index.html" target="_blank" rel="noopener">国盾量子</a></p>
<p><a href="http://www.qasky.com/" target="_blank" rel="noopener">问天量子</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://renzheng0403.github.io/2017/09/09/2017-09-09-SSL-and-TLS-知识点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="renzheng">
      <meta itemprop="description" content="what's past is prologue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="renz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/2017-09-09-SSL-and-TLS-知识点/" itemprop="url">
                  SSL and TLS 知识点
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-09-09 00:00:00" itemprop="dateCreated datePublished" datetime="2017-09-09T00:00:00+08:00">2017-09-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-19 09:03:31" itemprop="dateModified" datetime="2018-05-19T09:03:31+08:00">2018-05-19</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SSL/" itemprop="url" rel="index"><span itemprop="name">SSL</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>TLS四个核心主协议：</p>
<ul>
<li>handshake protocol 握手协议</li>
<li>change cipher spec protocol 密钥规格变更协议</li>
<li>application data protocol 应用数据协议</li>
<li><p>alert protocol 警报协议</p>
</li>
<li><p>record协议：包括对消息的分段、压缩、消息认证和完整性保护、加密</p>
</li>
</ul>
<p>SSL核心功能：握手、密钥交换、相互认证、保密数据传输</p>
<p>SSL握手的三个目的：</p>
<ul>
<li>客户端与服务器就一组保护数据的算法达成一致</li>
<li>确立一组由算法使用的密钥</li>
<li>还可以选择对客户端身份进行认证</li>
</ul>
<p>由于SSL/TLS协议自身特性（数字证书），不能被用于保护多跳端到端通信，只能保护点到点通信。</p>
<p>SSL/TLS协议能够提供的安全目标：</p>
<ul>
<li>身份认证（数字证书）</li>
<li>机密传输（信息加密）</li>
<li>数据完整性（MAC）</li>
<li>重放保护（通过使用隐式序列号防止重放攻击）</li>
</ul>
<h1 id="1-SSL总体流程"><a href="#1-SSL总体流程" class="headerlink" title="1 SSL总体流程"></a>1 SSL总体流程</h1><p><img src="/images/SSL握手概述.png" alt="SSL握手概述"></p>
<ol>
<li>客户端将其支持的算法列表和一个用作密钥生成算法输入的随机数发送给服务器</li>
<li>服务器选择一个加密算法，并将其和包含服务器公钥的证书发送给客户端，还包括一个用作密钥生成算法输入的随机数</li>
<li>客户端验证服务器证书，并抽取服务器公钥。同时生成一个pre_master_secret随即密码串，然后使用服务器公钥对其进行加密，将加密的信息发送给服务器</li>
<li>客户端和服务器根据pre_master_secret和随机数值独立计算加密密钥和MAC密钥</li>
<li>客户端将所有握手消息MAC值加密后发送给服务器</li>
<li>服务器将所有握手消息MAC值加密后发送给客户端</li>
</ol>
<h1 id="2-SSL连接"><a href="#2-SSL连接" class="headerlink" title="2 SSL连接"></a>2 SSL连接</h1><p><img src="/images/SSL连接.png" alt="SSL连接"></p>
<ol>
<li>握手消息ClientHello，用于告知服务器客服端所支持的密码套件种类、最高SSL/TLS协议版本以及压缩算法。还包括一个客户端生成的用于密钥产生的随机数，在密钥生成过程中被使用（其它有Session值，第一次握手为0；版本号）</li>
<li>服务器返回的一系列握手消息。首先是ServerHello，包含了服务器选择的加密参数。还包括一个服务器生成的用于密钥产生的随机数，如果是第一次握手，服务器将提供给客户端一个Session值用于恢复使用已经协商好的密钥信息</li>
<li>服务器发送Certificate，该消息是X.509证书序列，证书依序提供，从服务器证书开始，到Certificate authority或者最新的自签名证书结束。同时证书会附带携带与协商的密钥交换算法对应的密钥。客户端除了校验签名信息，还要保证证书链中的所有证书均未被吊销。</li>
<li>ServerHelloDone，表示服务器已发送在此阶段要发送的全部信息。此项告诉客户端本次Certificate后面没有可选信息，不用再等了</li>
<li>ClientKeyExchange客户端验证了服务端证书并并抽取公钥后，使用服务器公钥对生成的被称为pre_master_secret的随机密钥串加密，再通过此消息发送</li>
<li>ChangeCipherSpec告诉服务器，客户端之后的消息都是用商定的加密算法，此消息不属于握手消息，</li>
<li>Finished 发送前一阶段的所有握手消息MAC值，对握手消息校验，这样服务器可以判断使用的加密算法是否是安全商定的，而没有遭到中间人篡改或诱导</li>
<li>ChangeCipherSpec告诉客户端，服务器之后的消息都使用商定的加密算法</li>
<li>Finished</li>
</ol>
<h2 id="ClientHello"><a href="#ClientHello" class="headerlink" title="ClientHello"></a>ClientHello</h2><p>结构体：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line"> ProtocolVersion client_version<span class="comment">;</span></span><br><span class="line"> <span class="built_in">Random</span> <span class="built_in">random</span><span class="comment">;</span></span><br><span class="line"> SessionlD session_id<span class="comment">; </span></span><br><span class="line">  CipherSuite cipher_suites&lt;<span class="number">2</span>..<span class="number">2</span>^<span class="number">16</span>-1&gt;<span class="comment">;</span></span><br><span class="line"> CompressionMethod compression_methods&lt;l..<span class="number">2</span>^<span class="number">8</span>-1&gt;<span class="comment">;</span></span><br><span class="line">&#125; ClientHello<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">struct &#123;</span><br><span class="line"> uint8 major<span class="comment">;</span></span><br><span class="line"> uint8 minor<span class="comment">;</span></span><br><span class="line">&#125; ProtocolVersion<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">struct &#123;</span><br><span class="line"> uint32 gmt_unix_time<span class="comment">;</span></span><br><span class="line"> opaque random_bytes[<span class="number">28</span>]<span class="comment">;</span></span><br><span class="line">&#125; <span class="built_in">Random</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">opaque SessionlD&lt;<span class="number">0</span>..<span class="number">32</span>&gt;<span class="comment">;</span></span><br><span class="line">uint8 CipherSuite[<span class="number">2</span>]<span class="comment">;</span></span><br><span class="line">enum &#123;null(<span class="number">0</span>),(<span class="number">255</span>)&#125; CompressionMethod<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>消息：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Handshake Protocol:<span class="built_in"> Client </span>Hello</span><br><span class="line">    Handshake Type:<span class="built_in"> Client </span>Hello (1)</span><br><span class="line">    Version: TLS 1.2 (0x0303)</span><br><span class="line">    Random</span><br><span class="line">        GMT Unix Time: Apr 13, 2053 09:32:30.000000000 �й���׼ʱ��</span><br><span class="line">        Random Bytes: b383297830cf9a3e82ddd7152edff8f6d015fbd697f3a5d8<span class="built_in">..</span>.</span><br><span class="line">    Session ID: d8ae81d62bd18b0cc3f1e7b8774bdd2b1e4755419ab1058e<span class="built_in">..</span>.</span><br><span class="line">    Cipher Suites (14 suites)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xc02c)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)</span><br><span class="line">        Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014)</span><br><span class="line">        Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)</span><br><span class="line">        Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)</span><br><span class="line">        Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)</span><br><span class="line">        Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)</span><br><span class="line">        Cipher Suite: TLS_RSA_WITH_3DES_EDE_CBC_SHA (0x000a)</span><br><span class="line">    Compression Methods (1 method)</span><br><span class="line">        Compression Method: <span class="literal">null</span> (0)</span><br><span class="line">    Extensions Length: 407</span><br><span class="line">    Extension: renegotiation_info</span><br><span class="line">        Renegotiation <span class="builtin-name">Info</span> extension</span><br><span class="line">            Renegotiation <span class="builtin-name">info</span> extension length: 0</span><br><span class="line">    Extension: server_name</span><br><span class="line">       <span class="built_in"> Server </span>Name Indication extension</span><br><span class="line">           <span class="built_in"> Server </span>Name: www.baidu.com</span><br><span class="line">    Extension: signature_algorithms</span><br><span class="line">        Signature Hash Algorithms (9 algorithms)</span><br><span class="line">            Signature Hash Algorithm: 0x0403</span><br><span class="line">                Signature Hash Algorithm Hash: SHA256 (4)</span><br><span class="line">                Signature Hash Algorithm Signature: ECDSA (3)</span><br><span class="line">            Signature Hash Algorithm: 0x0401</span><br><span class="line">                Signature Hash Algorithm Hash: SHA256 (4)</span><br><span class="line">                Signature Hash Algorithm Signature: RSA (1)</span><br><span class="line">            </span><br><span class="line">    Extension: elliptic_curves</span><br><span class="line">        Elliptic curves (4 curves)</span><br><span class="line">            Elliptic curve: Unknown (0xaaaa)</span><br><span class="line">            Elliptic curve: Unknown (0x001d)</span><br><span class="line">            Elliptic curve: secp256r1 (0x0017)</span><br><span class="line">            Elliptic curve: secp384r1 (0x0018)</span><br></pre></td></tr></table></figure></p>
<p>客户端在新建连接后，希望重新协商或者响应服务器发起的重新协商请求时，发送这条消息。该消息将客户端的功能和首选项传送给服务器，包含以下关键元素：</p>
<ul>
<li>Version 协议版本，包含客户端准备接受的最高SSL版本号</li>
<li>Random 握手时客户端与服务器都会提供随机数，用于身份验证，可以防止重放攻击（<strong>但是为什么</strong>）<ul>
<li>Client time（4byte)产生消息时的时间</li>
<li>Random bytes（28byte）随机生成，确保即使使用同一个pre_master_secret</li>
</ul>
</li>
<li>Session ID客户端用来指示希望重复使用前一次连接是的加密密钥资料</li>
<li>Ciper Suites 密码套件，指定服务器的认证算法、密钥交换算法、批量加密算法和摘要算法（消息完整性）。可参考(ssl握手协议中的CipherSuite)[<a href="http://blog.csdn.net/dog250/article/details/5750992]" target="_blank" rel="noopener">http://blog.csdn.net/dog250/article/details/5750992]</a> ，baidu一篇正好是公司前辈的文章</li>
<li>Compression Methods 客户端可以提交一个或多个支持压缩的方法。默认的压缩方法是null</li>
<li>Extensions 扩展额外数据</li>
</ul>
<h2 id="ServerHello"><a href="#ServerHello" class="headerlink" title="ServerHello"></a>ServerHello</h2><p>将服务器选择的连接参数传回客户端<br>结构与ClientHello类似：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Handshake Protocol:<span class="built_in"> Server </span>Hello</span><br><span class="line">    Version: TLS 1.2 (0x0303)</span><br><span class="line">    Random</span><br><span class="line">        GMT Unix Time: Sep  9, 2017 14:38:09.000000000 �й���׼ʱ��</span><br><span class="line">        Random Bytes: d3fe2fbdbbe626fc09b691158652d6808239d05b7b9ed0a3<span class="built_in">..</span>.</span><br><span class="line">    Session ID: d8ae81d62bd18b0cc3f1e7b8774bdd2b1e4755419ab1058e<span class="built_in">..</span>.</span><br><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</span><br><span class="line">    Compression Method: <span class="literal">null</span> (0)</span><br><span class="line">    Extension: Application Layer Protocol Negotiation</span><br><span class="line">        ALPN Protocol</span><br><span class="line">            ALPN Next Protocol: http/1.1</span><br></pre></td></tr></table></figure></p>
<p>服务器也提供了一个随机值，用它连同客户端提供的随机值，以及pre_master_secret一起产生密钥资料。</p>
<h2 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h2><p>X.509证书序列</p>
<h2 id="ServerHelloDone"><a href="#ServerHelloDone" class="headerlink" title="ServerHelloDone"></a>ServerHelloDone</h2><p>是一条空消息，表明服务器已经发送了在此阶段要发送的全部消息</p>
<h2 id="ClientKeyExchange"><a href="#ClientKeyExchange" class="headerlink" title="ClientKeyExchange"></a>ClientKeyExchange</h2><p>携带客户端为密钥交换提供的所有信息<br>结构体：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line"> <span class="keyword">select</span> (KeyExchangeAIgorithm) &#123;</span><br><span class="line"> <span class="keyword">case</span> rsa: EncryptedPreMasterSecret;</span><br><span class="line"> <span class="keyword">case</span> diffie_hellman: DiffieHellmanClientPublicValue;</span><br><span class="line"> &#125; exchange_keys;</span><br><span class="line">&#125; ClientKeyExchange;</span><br><span class="line">struct &#123;</span><br><span class="line"> ProtocolVersion client_version;</span><br><span class="line"> opaque random[<span class="number">46</span>];</span><br><span class="line">&#125; PreMasterSecret;</span><br><span class="line">struct &#123;</span><br><span class="line"> <span class="keyword">public</span>-key-encrypted PreMasterSecret pre_master_secret;</span><br><span class="line">&#125; EncryptedPreMasterSecret;</span><br><span class="line"><span class="keyword">enum</span> &#123; <span class="keyword">implicit</span>, explicit &#125; PublicValueEncoding;</span><br><span class="line">struct &#123;</span><br><span class="line"> <span class="keyword">select</span> (PublicValueEncoding) &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="keyword">implicit</span>: struct &#123;&#125;;</span><br><span class="line"> <span class="keyword">case</span> explicit: opaque DH_Yc&lt;I.<span class="number">.2</span>^<span class="number">16</span>-<span class="number">1</span> &gt;;</span><br><span class="line"> &#125; dh_public;</span><br><span class="line">&#125; DiffieHellmanClientPublicValue;</span><br></pre></td></tr></table></figure></p>
<h2 id="ChangeCipherSpec（不属于握手消息）"><a href="#ChangeCipherSpec（不属于握手消息）" class="headerlink" title="ChangeCipherSpec（不属于握手消息）"></a>ChangeCipherSpec（不属于握手消息）</h2><p>指示发送实现已经切换好的算法和密钥资料，之后发送的消息将使用算法加以保护</p>
<h2 id="Finished"><a href="#Finished" class="headerlink" title="Finished"></a>Finished</h2><p>结构体：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">SSLv3:</span></span><br><span class="line">struct &#123;</span><br><span class="line"> opaque md5_hash[<span class="number">16</span>]<span class="comment">;</span></span><br><span class="line"> opaque <span class="keyword">sha_hash[20];</span></span><br><span class="line"><span class="keyword">&#125;Finished;</span></span><br><span class="line"><span class="keyword">TLS:</span></span><br><span class="line"><span class="keyword">struct </span>&#123;</span><br><span class="line"> opaque verify_data[<span class="number">12</span>]<span class="comment">;</span></span><br><span class="line">&#125; Finished<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>每一方向另一方发送协商后的主密码与连结起来的握手消息的摘要信息，另一方将其与本地计算得出的摘要对比。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5_hash = MD5(<span class="name">master_secret</span> + pad2 + MD5(<span class="name">handshake_messages</span> + Sender + master_secret + pad1) )<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>第一遍调用MD5的输入：所有握手消息、Sender常量、master_secret、填充字节（pad1为字节0x36重复48次所形成的字符串）</p>
<p>第二遍调用MD5的输入：主密码、填充字节（pad2为字节0x5c重复48次所形成的字符串）、第一遍的输出</p>
<p>Finished另一个有趣的地点在于第二个发送Finished的一方将前一个Finished的消息计算在摘要值之内的可能性，如下图所示：<br><img src="/images/SSL-handshark-Finished.png" alt="Finished"><br>这样当服务器计算握手消息的时候会多计算两个握手消息，必然不会匹配。解决的办法是在处理Finished消息之前再创建一份摘要对象的拷贝。</p>
<h1 id="3-SSL记录协议"><a href="#3-SSL记录协议" class="headerlink" title="3 SSL记录协议"></a>3 SSL记录协议</h1><p><img src="/images/SSL记录层.png" alt="SSL记录层协议"></p>
<p>SSL记录层协议将数据流分割成片段加密传输</p>
<p>记录头包含三种信息：内容类型、长度、SSL版本</p>
<p>结构体：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"> ContentType <span class="keyword">type</span>;</span><br><span class="line"> ProtocolVersion version;</span><br><span class="line"> uint16 length;</span><br><span class="line">&#125; RecordHeader;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line"> change_cipher_spec(<span class="number">20</span>), alert(<span class="number">21</span>), handshake(<span class="number">22</span>),</span><br><span class="line"> application_data(<span class="number">23</span>), (<span class="number">255</span>)</span><br><span class="line">&#125; ContentType;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"> uint8 major;</span><br><span class="line"> uint8 minor;</span><br><span class="line">&#125; ProtocolVersion;</span><br></pre></td></tr></table></figure></p>
<h3 id="内容类型"><a href="#内容类型" class="headerlink" title="内容类型"></a>内容类型</h3><p>SSL支持四种内容类型：application_data、alert、handshark、change_cipher_spec</p>
<p>alert用于报告各种类型的错误</p>
<p>handshark用于承载握手信息</p>
<p>change_cipher_spec表示加密及认证的改变，指示使用新的密钥</p>
<h3 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h3><p>让接收方知道要从线路上读取多少字节消息</p>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><h1 id="4-会话恢复"><a href="#4-会话恢复" class="headerlink" title="4 会话恢复"></a>4 会话恢复</h1><p>先看与百度的握手过程：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">459</span>	<span class="number">22.284378</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	TLSv1<span class="number">.2</span>	<span class="number">571</span>	Client Hello</span><br><span class="line"><span class="number">461</span>	<span class="number">22.294188</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	TLSv1<span class="number">.2</span>	<span class="number">150</span>	Server Hello</span><br><span class="line"><span class="number">462</span>	<span class="number">22.294210</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	TLSv1<span class="number">.2</span>	<span class="number">60</span>	Change Cipher Spec</span><br><span class="line"><span class="number">464</span>	<span class="number">22.295709</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	TLSv1<span class="number">.2</span>	<span class="number">99</span>	Hello Request, Hello Request</span><br><span class="line"><span class="number">465</span>	<span class="number">22.295942</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	TLSv1<span class="number">.2</span>	<span class="number">105</span>	Change Cipher Spec, Hello Request, Hello Request</span><br><span class="line"><span class="number">468</span>	<span class="number">22.299020</span>	<span class="number">192.168</span><span class="number">.41</span><span class="number">.110</span>	<span class="number">115.239</span><span class="number">.211</span><span class="number">.112</span>	TLSv1<span class="number">.2</span>	<span class="number">82</span>	Application Data</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>这里由于ClientHello提供了一个Session，使用了前一次SSL握手协商好的加密密钥信息，因此当客户端接收到ServerHello后就发送ChangeCipherSpec通知服务端后面的消息将使用之前的加密密钥加密</p>
<p>可以发现省略了Certificate，ClientKeyExchange，并不涉及到密钥及加密算法交换等信息，而且此后的消息都是通过加密密钥发送的，如果攻击者冒充服务端，自然无法解开收到的消息，这解释了为什么客户端没有验证服务端身份。</p>
<p>恢复SSL会话流程：<br><img src="/images/SSL-Session.png" alt="SSL-Session"></p>
<h1 id="5-客户端身份验证"><a href="#5-客户端身份验证" class="headerlink" title="5 客户端身份验证"></a>5 客户端身份验证</h1><p>服务器通过发送CertificateRequest消息请求对客户端进行身份验证，客户端接受后发送自己的Certificate消息，再发送CertificateVerify消息证明自己拥有对应的私钥。</p>
<p>服务器将告诉客户端，我接受哪些证书和签名算法，或者接受哪些证书颁发机构：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ClientCertificateType certificate_types;</span><br><span class="line">    SignatureAndHashAlgorithm supported_signature_algorithms;</span><br><span class="line">    DistinguishedName certificate_authorities;</span><br><span class="line">&#125; CertificateRequest;</span><br><span class="line"><span class="class"><span class="keyword">enum</span>&#123;</span></span><br><span class="line"> rsa_sign(<span class="number">1</span>),dss_sign(<span class="number">2</span>),rsa_fixed_dh(<span class="number">3</span>),dss_fixed_dh(<span class="number">4</span>),</span><br><span class="line"> (<span class="number">255</span>)</span><br><span class="line">&#125;ClientCertificateType;</span><br><span class="line">opaque DistinguishedName&lt;l..<span class="number">2</span>^<span class="number">16</span>-<span class="number">1</span>&gt;;</span><br></pre></td></tr></table></figure></p>
<p>客户端将发送一条到这一步为止的所有握手消息的签名，以此证明自己拥有的私钥与之前发送的客户端证书中的公钥匹配：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line">    Signature handshark_message_signature<span class="comment">;</span></span><br><span class="line">&#125; CertificateVerify<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>若是你对我的私钥与证书中CA机构确认的公钥有怀疑，可以自己进行计算签名值对比（我觉得一定会的）</p>
<h1 id="6-临时RSA"><a href="#6-临时RSA" class="headerlink" title="6 临时RSA"></a>6 临时RSA</h1><p>ServerKeyExchange（在ServerHelloDone之前）服务器使用该消息传输经过签名的512bit RSA密钥，客户端收到该消息后，验证临时密钥上的服务器签名，并使用其加密pre_master_secret</p>
<h1 id="7-再握手（Rehandshake）"><a href="#7-再握手（Rehandshake）" class="headerlink" title="7 再握手（Rehandshake）"></a>7 再握手（Rehandshake）</h1><p>建立SSL连接之后再进行一次握手，客户端发送一条ClientHello，如果服务器同意，发送空的HelloRequest握手消息，客户端发送ClientHello作为响应。如果服务器不同意，发送一条no_renegotiation警示。</p>
<h1 id="8-密钥交换算法的区别"><a href="#8-密钥交换算法的区别" class="headerlink" title="8 密钥交换算法的区别"></a>8 密钥交换算法的区别</h1><p>密钥交换的目的是计算<strong>预主密钥</strong>（premaster secret），这个值是组成<strong>主密钥</strong>（master secret）的来源。</p>
<h2 id="8-1-TLS-RSA"><a href="#8-1-TLS-RSA" class="headerlink" title="8.1 TLS-RSA"></a>8.1 TLS-RSA</h2><p>PreMasterSecret由客户端指定，并用RSA公钥加密发送给服务器。</p>
<h2 id="8-2-TLS-DH"><a href="#8-2-TLS-DH" class="headerlink" title="8.2 TLS-DH"></a>8.2 TLS-DH</h2><p>双方各自提交一个证书包含DH公开值，服务器端提交证书包含DH公开值。</p>
<h2 id="8-3-TLS-DHE"><a href="#8-3-TLS-DHE" class="headerlink" title="8.3 TLS-DHE"></a>8.3 TLS-DHE</h2><p>基于DHE的TLS握手中有ServerKeyExchange消息。DH参数和它的数字签名均被包含在消息中，握手过程中交换参数的认证就是通过数字签名实现，支持的签名算法包括RSA和DSS。</p>
<h2 id="附：Diffie-Hellman密钥交换"><a href="#附：Diffie-Hellman密钥交换" class="headerlink" title="附：Diffie-Hellman密钥交换"></a>附：Diffie-Hellman密钥交换</h2><p>抛开算法的细节（因为我不懂），DH密钥交换需要6个参数：</p>
<ul>
<li>域参数（服务器选取）<ul>
<li>dh_p</li>
<li>dh_g</li>
</ul>
</li>
<li>客户端<ul>
<li>dh_Ys</li>
<li>dh_Yc</li>
</ul>
</li>
<li>服务器<ul>
<li>dh_Ys</li>
<li>dh_Yc</li>
</ul>
</li>
</ul>
<p>协商过程中客户端和服务器相互发送其中一个参数（dh_Ys和dh_Yc）到对端</p>
<p>服务器发送ServerDHparams:<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line">    opaque dh_p<span class="comment">;</span></span><br><span class="line">    opaque dh_g<span class="comment">;</span></span><br><span class="line">    opaque dh_Ys<span class="comment">;</span></span><br><span class="line">&#125; ServerDHParams<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>客户端相应并发送其公开参数（dh_Yc）:<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line">    <span class="keyword">select</span> (PublicValueEncoding) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">implicit</span>:</span><br><span class="line">        <span class="keyword">case</span> explicit:</span><br><span class="line">            opaque dh_Yc;</span><br><span class="line">    &#125; dh_public;</span><br><span class="line">&#125;ClientDiffHellmanPublic;</span><br></pre></td></tr></table></figure></p>
<h1 id="9-密钥生成"><a href="#9-密钥生成" class="headerlink" title="9 密钥生成"></a>9 密钥生成</h1><p>Pseudo-random Function（PRF，伪随机函数）：秘密值扩展、密钥生成</p>
<p>工作原理如图<br><img src="/images/PRF.png" alt=""><br>PRF基于两个hash函数：MD5和SHA-1；</p>
<p>有三个输入：</p>
<ul>
<li>Secret，例如PreMasterSecret，在使用时被分为长度相同的两半：S1和S2，跟别作为P_MD5和P_SHA-1的输入。</li>
<li>Label标志服</li>
<li>Seed种子值（客户端随机数+服务器随机数）</li>
</ul>
<p>SSL/TLS协议密钥的生成过程：<br><img src="/images/SSL-key.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">renzheng</p>
              <p class="site-description motion-element" itemprop="description">what's past is prologue</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">renzheng</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
